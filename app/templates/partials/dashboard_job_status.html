{% set state = job.state %}
{% set is_active = state in ['queued', 'running'] %}

{% if kind in ['ingest', 'import'] %}
  {% set target_id = 'ingestStatusWrap-' ~ job.job_id %}
  {% set title = 'Ingest job' %}
{% elif kind == 'phone_sync' %}
  {% set target_id = 'phoneSyncStatusWrap-' ~ job.job_id %}
  {% set title = 'Phone sync job' %}
{% elif kind == 'phone_reconcile' %}
  {% set target_id = 'phoneReconcileStatusWrap-' ~ job.job_id %}
  {% set title = 'Phone reconcile job' %}
{% else %}
  {% set target_id = 'validateStatusWrap-' ~ job.job_id %}
  {% set title = 'Validate job' %}
{% endif %}
{% set poll_url = '/phototank/dashboard/job/status/' ~ job.job_id %}

<div
  id="{{ target_id }}"
  class="border rounded p-2"
  {% if is_active %}
    hx-get="{{ poll_url }}"
    hx-trigger="load, every 2s"
    hx-swap="outerHTML"
  {% endif %}
>
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <div class="fw-semibold">{{ title }}</div>
      <div class="text-muted small">job_id: {{ job.job_id }}{% if job.year %} Â· year: {{ job.year }}{% endif %}</div>
    </div>
    <div>
      {% if state == 'done' %}
        <span class="badge text-bg-success">done</span>
      {% elif state == 'failed' %}
        <span class="badge text-bg-danger">failed</span>
      {% elif state == 'running' %}
        <span class="badge text-bg-primary">running</span>
      {% else %}
        <span class="badge text-bg-secondary">{{ state }}</span>
      {% endif %}
    </div>
  </div>

  <div class="mt-2 small">
    <div class="row g-2">
      <div class="col-6 col-md-3"><span class="text-muted">processed:</span> {{ job.processed }}</div>
      <div class="col-6 col-md-3"><span class="text-muted">upserted:</span> {{ job.upserted }}</div>
      <div class="col-6 col-md-3"><span class="text-muted">thumbs:</span> {{ job.thumbs_done }}</div>
      <div class="col-6 col-md-3"><span class="text-muted">mids:</span> {{ job.mids_done }}</div>
      <div class="col-6 col-md-3"><span class="text-muted">errors:</span> {{ job.errors }}</div>
      <div class="col-6 col-md-9"><span class="text-muted">message:</span> {{ job.message or '' }}</div>
      <div class="col-12"><span class="text-muted">started:</span> {{ job.started_at or '' }} <span class="text-muted ms-2">finished:</span> {{ job.finished_at or '' }}</div>
    </div>
  </div>
</div>
